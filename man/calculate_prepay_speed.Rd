% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculate_prepay_speed.R
\name{calculate_prepay_speed}
\alias{calculate_prepay_speed}
\title{Calculate Single Monthly Mortality and Conditional Prepayment Rate}
\usage{
calculate_prepay_speed(
  df,
  group_vars,
  prepay_config = list(col_effdate = "EFFDATE", col_origdate = "ORIGDATE", col_typecode =
    "TYPECODE", col_balance = "BAL", col_orig_balance = "ORIGBAL", col_payment =
    "PAYAMT", col_rate = "CURRINTRATE", col_interest_basis = NULL, interest_basis = 365,
    allow_negative_prepay = FALSE, min_begin_balance = 0)
)
}
\arguments{
\item{df}{Data frame containing loan-level monthly snapshot data.
Each row represents a loan's status for a given reporting period.
Data should include only active loans (open and non-performing).}

\item{group_vars}{Character vector specifying columns to group by when calculating
aggregate prepayment rates (e.g., \code{c("EFFDATE", "TYPECODE")}).
These typically represent reporting period and loan product type.}

\item{prepay_config}{List containing column name mappings and calculation parameters:
\describe{
\item{\code{col_effdate}}{Name of reporting/effective date column (default: "EFFDATE")}
\item{\code{col_origdate}}{Name of origination date column (default: "ORIGDATE")}
\item{\code{col_typecode}}{Name of loan type/product column (default: "TYPECODE")}
\item{\code{col_balance}}{Name of current loan balance column (default: "BAL")}
\item{\code{col_orig_balance}}{Name of original/funded balance column (default: "ORIGBAL")}
\item{\code{col_payment}}{Name of contractual payment amount column (default: "PAYAMT")}
\item{\code{col_rate}}{Name of current interest rate column (default: "CURRINTRATE")}
\item{\code{col_interest_basis}}{Name of loan-level interest basis column (optional, default: NULL).
If provided, uses loan-level interest calculation basis. If NULL, uses global \code{interest_basis} parameter.}
\item{\code{interest_basis}}{Number of days in year for interest calculation (global fallback).
Use 360 or 365 for daily interest method, or NULL/NA for simple monthly division.
Ignored if \code{col_interest_basis} is specified (default: 365)}
\item{\code{allow_negative_prepay}}{Logical indicating whether to allow negative
SMM/CPR values. If FALSE, negative values are floored at 0 (default: FALSE)}
\item{\code{min_begin_balance}}{Numeric threshold for minimum beginning balance.
Cohorts with beginning balance below this value are excluded from results (default: 0)}
}}
}
\value{
Data frame with columns:
\describe{
\item{Grouping columns}{As specified in \code{group_vars}}
\item{\code{BEGIN_BAL}}{Beginning loan balance for the period}
\item{\code{END_BAL}}{Ending loan balance for the period}
\item{\code{SCHED_PRIN_TOTAL}}{Total scheduled principal for the period}
\item{\code{FUNDED_BAL}}{Loans funded during the period (new originations)}
\item{\code{ACTUAL_PRIN}}{Actual principal paid (including prepayments)}
\item{\code{PREPAYMENT}}{Principal paid in excess of scheduled amount}
\item{\code{SMM}}{Single monthly mortality (0 to 1 scale)}
\item{\code{CPR}}{Conditional prepayment rate, annualized from SMM (0 to 1 scale)}
}
}
\description{
Computes single monthly mortality (SMM) and conditional prepayment rate (CPR)
for loan pools by cohort, accounting for scheduled versus actual principal payments.
Supports flexible column naming, loan-level or global interest rate calculation methods
for different financial institution systems.
}
\details{
\strong{Methodology:}

SMM measures the monthly prepayment rate relative to beginning balance:
\deqn{SMM = \frac{PREPAYMENT}{BEGIN\_BAL}}{SMM = PREPAYMENT / BEGIN_BAL}

CPR annualizes SMM using the standard conversion formula:
\deqn{CPR = 1 - (1 - SMM)^{12}}{CPR = 1 - (1 - SMM)^12}

Principal flow calculation accounts for new originations:
\deqn{ACTUAL\_PRIN = BEGIN\_BAL - END\_BAL + FUNDED\_BAL}

Scheduled principal is calculated as payment minus interest:
\deqn{SCHEDPRIN = PAYMENT - INTEREST}

\strong{Interest Calculation Methods:}
\itemize{
\item \strong{Loan-level basis} (when \code{col_interest_basis} is specified):
Each loan uses its own interest basis. For loans with basis 360 or 365:
\eqn{INTEREST = BAL \times RATE \times \frac{DAYS\_IN\_MONTH}{LOAN\_BASIS}}
For loans with invalid/missing basis: \eqn{INTEREST = BAL \times \frac{RATE}{12}}
\item \strong{Global basis} (when \code{col_interest_basis} is NULL):
If \code{interest_basis} is 360 or 365:
\eqn{INTEREST = BAL \times RATE \times \frac{DAYS\_IN\_MONTH}{interest\_basis}}
Otherwise: \eqn{INTEREST = BAL \times \frac{RATE}{12}}
}

\strong{Data Requirements:}
\itemize{
\item Loan-level data with monthly snapshots (one row per loan per reporting date)
\item Data should include only active loans (open and non-performing)
\item All required columns must be present (checked on function entry)
\item Balances and payments should be positive numeric values
\item Interest rates should be decimals (e.g., 0.0729 for 7.29\\%)
\item Date columns must be coercible to Date format
\item If using loan-level basis, values should be 360 or 365 (invalid values use simple monthly)
}

\strong{FUNDED_BAL Interpretation:}
FUNDED_BAL represents loans originated during the reporting period. This is calculated
by identifying loans where the origination date (month and year) matches the reporting
period. These new originations are added to the beginning balance to properly calculate
the principal available for repayment during the period.
}
\section{Notes}{

\itemize{
\item The first month of data is excluded automatically (no prior month for lagging)
\item By default, SMM and CPR are floored at 0 (set \code{allow_negative_prepay = TRUE} to disable)
\item NA values in balance or payment columns are removed with \code{na.rm = TRUE}
\item Cohorts with beginning balance below \code{min_begin_balance} are filtered out
\item The function uses \code{lubridate} for date handling and \code{dplyr} for data manipulation
\item Loan-level interest basis takes precedence over global \code{interest_basis} parameter
}
}

\examples{
\dontrun{
# Example 1: Loan-level interest basis (mixed 360/365 in same portfolio)
prepay_config_loan_level <- list(
  col_effdate = "EFFDATE",
  col_origdate = "ORIGDATE",
  col_typecode = "TYPECODE",
  col_balance = "BAL",
  col_orig_balance = "ORIGBAL",
  col_payment = "PAYAMT",
  col_rate = "CURRINTRATE",
  col_interest_basis = "INT_BASIS",  # Loan-level column
  allow_negative_prepay = FALSE,
  min_begin_balance = 10000
)

result_loan_level <- calculate_prepay_speed(
  df = loan_pool_data,
  group_vars = c("EFFDATE", "TYPECODE"),
  prepay_config = prepay_config_loan_level
)

# Example 2: Global interest basis (all loans use same method)
prepay_config_global <- list(
  col_effdate = "EFFDATE",
  col_origdate = "ORIGDATE",
  col_typecode = "TYPECODE",
  col_balance = "BAL",
  col_orig_balance = "ORIGBAL",
  col_payment = "PAYAMT",
  col_rate = "CURRINTRATE",
  col_interest_basis = NULL,  # Use global parameter
  interest_basis = 365,       # Applied to all loans
  allow_negative_prepay = FALSE,
  min_begin_balance = 10000
)

result_global <- calculate_prepay_speed(
  df = loan_pool_data,
  group_vars = c("EFFDATE", "TYPECODE"),
  prepay_config = prepay_config_global
)

# Example 3: Simple monthly interest (no daily calculation)
prepay_config_monthly <- list(
  col_effdate = "EFFDATE",
  col_origdate = "ORIGDATE",
  col_typecode = "TYPECODE",
  col_balance = "BAL",
  col_orig_balance = "ORIGBAL",
  col_payment = "PAYAMT",
  col_rate = "CURRINTRATE",
  interest_basis = NULL  # Will use RATE / 12 for all loans
)

result_monthly <- calculate_prepay_speed(
  df = loan_pool_data,
  group_vars = c("EFFDATE", "TYPECODE"),
  prepay_config = prepay_config_monthly
)

# Example 4: Minimal configuration (uses all defaults)
result_default <- calculate_prepay_speed(
  df = loan_pool_data,
  group_vars = c("EFFDATE", "TYPECODE")
)
}

}
