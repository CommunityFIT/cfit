% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculate_prepay_speed.R
\name{calculate_prepay_speed}
\alias{calculate_prepay_speed}
\title{Calculate Single Monthly Mortality and Conditional Prepayment Rate}
\usage{
calculate_prepay_speed(
  df,
  group_vars,
  prepay_config = list(col_effdate = "EFFDATE", col_origdate = "ORIGDATE", col_typecode =
    "TYPECODE", col_balance = "BAL", col_orig_balance = "ORIGBAL", col_payment =
    "PAYAMT", col_rate = "CURRINTRATE", col_interest_basis = NULL, col_loanid = NULL,
    interest_basis = 365, allow_negative_prepay = FALSE, min_begin_balance = 0),
  verbose = FALSE
)
}
\arguments{
\item{df}{Data frame containing loan-level monthly snapshot data.
Each row represents a loan's status for a given reporting period.
Data should include only active loans (open and non-performing).
\strong{Important:} Each loan should appear exactly once per reporting period.}

\item{group_vars}{Character vector specifying columns to group by when calculating
aggregate prepayment rates (e.g., \code{c("EFFDATE", "TYPECODE")}).
These typically represent reporting period and loan product type.
\strong{Note:} The effective date column must be included in group_vars.}

\item{prepay_config}{List containing column name mappings and calculation parameters:
\describe{
\item{\code{col_effdate}}{Name of reporting/effective date column (default: "EFFDATE")}
\item{\code{col_origdate}}{Name of origination date column (default: "ORIGDATE")}
\item{\code{col_typecode}}{Name of loan type/product column (default: "TYPECODE")}
\item{\code{col_balance}}{Name of current loan balance column (default: "BAL")}
\item{\code{col_orig_balance}}{Name of original/funded balance column (default: "ORIGBAL")}
\item{\code{col_payment}}{Name of contractual payment amount column (default: "PAYAMT")}
\item{\code{col_rate}}{Name of current interest rate column (default: "CURRINTRATE").
Rates should be in decimal form (e.g., 0.0729 for 7.29\\%). The function will
detect and convert percentage format with a warning.}
\item{\code{col_interest_basis}}{Name of loan-level interest basis column (optional, default: NULL).
If provided, uses loan-level interest calculation basis. If NULL, uses global \code{interest_basis} parameter.}
\item{\code{col_loanid}}{Name of unique loan identifier column (optional but recommended, default: NULL).
If provided: (1) validates that each loan appears only once per reporting period,
and (2) enables more accurate scheduled principal calculation using beginning-of-period balances.
Recommended for data quality assurance and calculation accuracy (e.g., "LOANNUMBER", "LOAN_ID").}
\item{\code{interest_basis}}{Number of days in year for interest calculation (global fallback).
Use 360 or 365 for daily interest method, or NULL/NA for simple monthly division.
Ignored if \code{col_interest_basis} is specified (default: 365)}
\item{\code{allow_negative_prepay}}{Logical indicating whether to allow negative
SMM/CPR values. If FALSE, negative values are floored at 0 (default: FALSE)}
\item{\code{min_begin_balance}}{Numeric threshold for minimum beginning balance.
Cohorts with beginning balance below this value are excluded from results (default: 0)}
}}

\item{verbose}{Logical indicating whether to print informational messages
about interest calculation methods and data filtering (default: FALSE)}
}
\value{
Data frame with columns:
\describe{
\item{Grouping columns}{As specified in \code{group_vars}}
\item{\code{BEGIN_BAL}}{Beginning loan balance for the period}
\item{\code{END_BAL}}{Ending loan balance for the period}
\item{\code{SCHED_PRIN_TOTAL}}{Total scheduled principal for the period}
\item{\code{FUNDED_BAL}}{Loans funded during the period (new originations, approximate)}
\item{\code{ACTUAL_PRIN}}{Actual principal paid (including prepayments)}
\item{\code{PREPAYMENT}}{Principal paid in excess of scheduled amount}
\item{\code{SMM}}{Single monthly mortality (0 to 1 scale)}
\item{\code{CPR}}{Conditional prepayment rate, annualized from SMM (0 to 1 scale)}
}
}
\description{
Computes single monthly mortality (SMM) and conditional prepayment rate (CPR)
for loan pools by cohort, accounting for scheduled versus actual principal payments.
Supports flexible column naming, loan-level or global interest rate calculation methods
for different financial institution systems.
}
\details{
\strong{Methodology:}

SMM measures the monthly prepayment rate relative to the pool available to prepay
(beginning balance minus scheduled principal):
\deqn{SMM = \frac{PREPAYMENT}{BEGIN\_BAL - SCHED\_PRIN\_TOTAL}}{SMM = PREPAYMENT / (BEGIN_BAL - SCHED_PRIN_TOTAL)}

CPR annualizes SMM using the standard conversion formula:
\deqn{CPR = 1 - (1 - SMM)^{12}}{CPR = 1 - (1 - SMM)^12}

Principal flow calculation accounts for new originations:
\deqn{ACTUAL\_PRIN = BEGIN\_BAL - END\_BAL + FUNDED\_BAL}

\strong{Scheduled Principal Calculation:}

The accuracy of scheduled principal depends on whether a loan ID is provided:

\itemize{
\item \strong{With col_loanid (recommended):} Scheduled principal is calculated using
beginning-of-period balance for each loan, providing accurate interest and principal separation:
\deqn{SCHEDPRIN = PAYMENT - (BEGIN\_BAL_{loan} \times MONTHLY\_RATE)}
\item \strong{Without col_loanid:} Scheduled principal uses end-of-period balance as an
approximation. This slightly overstates scheduled principal and understates prepayment
(typically <1-2\\% error):
\deqn{SCHEDPRIN \approx PAYMENT - (END\_BAL_{loan} \times MONTHLY\_RATE)}
}

\strong{Interest Calculation Methods:}
\itemize{
\item \strong{Loan-level basis} (when \code{col_interest_basis} is specified):
Each loan uses its own interest basis. For loans with basis 360 or 365:
\eqn{INTEREST = BAL \times RATE \times \frac{DAYS\_IN\_MONTH}{LOAN\_BASIS}}
For loans with invalid/missing basis: \eqn{INTEREST = BAL \times \frac{RATE}{12}}
\item \strong{Global basis} (when \code{col_interest_basis} is NULL):
If \code{interest_basis} is 360 or 365:
\eqn{INTEREST = BAL \times RATE \times \frac{DAYS\_IN\_MONTH}{interest\_basis}}
Otherwise: \eqn{INTEREST = BAL \times \frac{RATE}{12}}
}

\strong{Data Requirements:}
\itemize{
\item \strong{One row per loan per reporting date} - Each loan should appear exactly once
for each effective date. Use \code{col_loanid} parameter to validate this assumption.
\item Loan-level data with monthly snapshots (one row per loan per reporting date)
\item Data should include only active loans (open and non-performing)
\item All required columns must be present (checked on function entry)
\item Balances and payments should be positive numeric values
\item Interest rates should be in decimal form (e.g., 0.0729 for 7.29\\%). Percentage
format (e.g., 7.29) will be detected and converted with a warning.
\item Date columns must be coercible to Date format
\item If using loan-level basis, values should be 360 or 365 (invalid values use simple monthly)
}

\strong{FUNDED_BAL Interpretation:}

FUNDED_BAL is an approximation of new loan originations, calculated by identifying
loans where the origination date (month and year) matches the reporting period. It uses
the original funded amount (ORIGBAL) rather than actual cash flows, and matches by
month/year only. For precise cash flow analysis, consider using actual funding data
if available.

\strong{Data Quality Safeguards:}
\itemize{
\item SMM denominator adjusted for scheduled principal (industry standard PSA method)
\item SMM is clamped to valid ranges before CPR calculation to prevent mathematical errors
\item Scheduled principal is floored at 0 to handle interest-only periods
\item EFFDATE must be included in group_vars (validated on entry)
\item Data is automatically sorted by EFFDATE to ensure correct lag operations
\item Optional duplicate loan detection when col_loanid is provided
\item Interest rate format validation (detects percentage vs decimal)
}
}
\section{Notes}{

\itemize{
\item The first month of data is excluded automatically (no prior month for lagging)
\item By default, SMM and CPR are floored at 0 (set \code{allow_negative_prepay = TRUE} to disable)
\item NA values in balance or payment columns are removed with \code{na.rm = TRUE}
\item Cohorts with beginning balance below \code{min_begin_balance} are filtered out
\item The function uses \code{lubridate} for date handling and \code{dplyr} for data manipulation
\item Providing \code{col_loanid} improves both data quality and calculation accuracy
}
}

\examples{
\dontrun{
# Example 1: Basic usage with loan ID validation (recommended)
result <- calculate_prepay_speed(
  df = loan_pool_data,
  group_vars = c("EFFDATE", "TYPECODE"),
  prepay_config = list(
    col_loanid = "LOANNUMBER"  # Validates uniqueness and improves accuracy
  )
)

# Example 2: Custom column names with validation
custom_config <- list(
  col_effdate = "ReportDate",
  col_origdate = "OpenDate",
  col_typecode = "Product",
  col_balance = "CurrentBalance",
  col_orig_balance = "StartingBalance",
  col_payment = "MonthlyPayment",
  col_rate = "InterestRate",
  col_loanid = "LoanID",
  interest_basis = 360
)

result <- calculate_prepay_speed(
  df = loan_pool_data,
  group_vars = c("ReportDate", "Product"),
  prepay_config = custom_config
)

# Example 3: Without loan ID (less accurate scheduled principal)
result_approx <- calculate_prepay_speed(
  df = loan_pool_data,
  group_vars = c("EFFDATE", "TYPECODE")
  # No col_loanid: uses end balance approximation for scheduled principal
)
}

}
