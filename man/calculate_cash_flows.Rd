% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculate_cash_flows.R
\name{calculate_cash_flows}
\alias{calculate_cash_flows}
\title{Calculate Loan Portfolio Cash Flows}
\usage{
calculate_cash_flows(data, config = list())
}
\arguments{
\item{data}{A data frame containing loan portfolio snapshot data}

\item{config}{A list of configuration parameters. See details for structure.}
}
\value{
Depending on return_monthly_totals setting:
\itemize{
\item If FALSE: A data frame with loan-level cash flows containing columns:
LOAN_ID, eff_date, rate, tier, month, date, starting_balance, adjusted_balance, accrual_balance,
scheduled_payment, gross_interest, servicing_fee_amt, reporting_fee_amt,
total_fees, scheduled_principal, prepayment, total_principal, credit_loss,
remaining_balance, orig_fee, net_interest, total_payment, investor_principal,
investor_interest, investor_total
\item If TRUE: A list with two elements:
\itemize{
\item loan_cash_flows: Detailed loan-level cash flows (data frame)
\item monthly_totals: Aggregated monthly totals across all loans (data frame)
}
}
}
\description{
Generates monthly cash flow projections for a loan portfolio, incorporating
user-defined prepayment speeds (CPR), credit costs, and various fee structures.
}
\details{
Configuration list structure:
\itemize{
\item col_loanid: Column name for loan identifier (default: "LOAN_ID")
\item col_balance: Column name for current balance (default: "balance")
\item col_rate: Column name for interest rate as decimal (default: "current_interest_rate")
\item col_term: Column name for months to maturity (default: "months_to_maturity")
\item col_start_date: Column name for effective date (default: "eff_date")
\item col_tier: Column name for loan tier (default: NULL, optional)
\item col_monthly_payment: Column name for monthly payment (default: NULL, optional)
\item col_orig_balance: Column name for original balance (default: NULL, optional)
\item servicing_fee: Annual servicing fee rate as decimal (default: 0.0025)
\item annual_reporting_fee: Annual reporting fee rate as decimal (default: 0.00)
\item investor_share: Investor share percentage (default: 1.0 for 100\%)
\item origination_fee: Origination fee rate (default: 0.0000)
\item interest_on_starting_balance: Calculate interest before or after prepay/losses (default: FALSE)
\item credit_loss_reduces_interest: Whether credit losses reduce interest cash flows (default: TRUE).
By default, credit losses are applied against investor cash flows before distribution to investors.
When set to FALSE, credit losses reduce principal balances only and do not directly reduce interest cash flows.
\item de_minimis_balance: Threshold below which balance is forced to zero (default: 1.00)
\item cpr_vec: Named vector of CPR rates by tier (default: c("default" = 0.0))
\item credit_cost_vec: Named vector of annual credit cost rates by tier (default: c("default" = 0.0))
\item pd_vec: Optional named vector of PD rates (overrides credit_cost_vec if provided)
\item lgd_vec: Optional named vector of LGD rates (overrides credit_cost_vec if provided)
\item return_monthly_totals: Whether to return aggregated monthly totals (default: FALSE)
\item monthly_totals_group_vars: Optional character vector of column names to group monthly totals by,
in addition to date (default: NULL). For example, c("tier") to see monthly totals by tier.
\item show_progress: Show progress messages for large portfolios (default: TRUE)
}
}
\examples{
\dontrun{
# Create sample loan portfolio
loan_data <- data.frame(
  LOAN_ID = c("L001", "L002", "L003"),
  balance = c(25000, 50000, 15000),
  current_interest_rate = c(0.0599, 0.0649, 0.0549),
  months_to_maturity = c(60, 48, 36),
  eff_date = as.Date("2025-01-01")
)

# Define CPR and credit cost assumptions
config <- list(
  cpr_vec = c("default" = 0.05),
  credit_cost_vec = c("default" = 0.01),
  servicing_fee = 0.0025
)

# Generate cash flows
cash_flows <- calculate_cash_flows(loan_data, config)

# With monthly totals for portfolio yield calculation
config_totals <- list(
  cpr_vec = c("default" = 0.05),
  credit_cost_vec = c("default" = 0.01),
  return_monthly_totals = TRUE
)

results <- calculate_cash_flows(loan_data, config_totals)

# Calculate portfolio yield
library(FinCal)
pool_cfs <- data.frame(
  date = results$monthly_totals$date,
  amount = results$monthly_totals$investor_total
)

portfolio_yield <- yield.actual(
  cf = pool_cfs,
  pv = sum(loan_data$balance),
  start_date = min(loan_data$eff_date),
  compounding = "monthly"
)
}

}
