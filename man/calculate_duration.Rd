% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculate_duration.R
\name{calculate_duration}
\alias{calculate_duration}
\title{Calculate Portfolio Duration and Convexity}
\usage{
calculate_duration(
  loan_cash_flows,
  discount_rate = NULL,
  cash_flow_column = "total_payment",
  include_convexity = FALSE
)
}
\arguments{
\item{loan_cash_flows}{Data frame. Output from \code{calculate_cash_flows()}
containing projected loan cash flows with required columns: LOAN_ID,
rate, eff_date, date, month, total_payment, investor_total.}

\item{discount_rate}{Numeric or NULL. Annual discount rate for present value
calculations (e.g., 0.06 for 6\% per year). If NULL (default), uses each
loan's rate from the loan_cash_flows data. If a scalar, applies that rate
uniformly across all loans. When discount_rate is NULL, present values are
computed using loan-level rates, and the portfolio discount rate used in
the modified duration adjustment is the PV-weighted average loan rate.}

\item{cash_flow_column}{Character. Column name for cash flows to discount.
Options:
\itemize{
\item "total_payment" (default): Gross cash flow generated by the loan
(gross_interest + total_principal), before any fee deductions or
investor allocations
\item "investor_total": Net cash flow to the investor after applying
servicing fees, reporting fees, origination fees, credit losses
(if applicable), and investor_share percentage
}}

\item{include_convexity}{Logical. If TRUE, calculates and includes analytical
convexity in the output. Default is FALSE. Note: Analytical convexity
assumes cash flows are held constant; convexity reflects discounting effects
only and does not incorporate rate-dependent prepayment behavior. It answers
"What convexity would this portfolio have if borrowers didn't change
prepayment behavior?"}
}
\value{
A single-row data frame with portfolio-level metrics:
\itemize{
\item portfolio_pv: Total present value of all cash flows
\item macaulay_duration: Time-weighted average maturity in years
\item modified_duration: Interest rate sensitivity measure in years
\item analytical_convexity: (only if include_convexity = TRUE)
Fixed cash flow convexity measure
}
}
\description{
Calculates Macaulay duration, modified duration, and optionally analytical
convexity for a loan portfolio based on projected cash flows from
\code{calculate_cash_flows()}.
}
\details{
All calculations use monthly compounding. Present values are computed as:
PV_t = CF_t / (1 + y/12)^t, where y is the annual discount rate and t is
time in months from eff_date. The month column is treated as the projection
index, where month = 1 corresponds to time 0 (the effective date). Timing
calculations use t = (month - 1) / 12 for conversion to years.

Duration measures the weighted average time until cash flows are received,
expressed in years. Modified duration approximates the percentage change in
present value for a 1\% change in interest rates, assuming monthly compounding.

The function calculates:
\itemize{
\item Macaulay Duration = Σ(t × PV_t) / Σ(PV_t), where t is time in years
\item Modified Duration = Macaulay Duration / (1 + y/12), where y is the
discount rate and 12 represents monthly compounding
\item Analytical Convexity = Σ(PV_t × t × (t + 1/12)) / (PV × (1 + y/12)^2),
where t is in years and the formula reflects monthly compounding
}

When discount_rate is NULL, the function uses a weighted average of loan rates
for the modified duration calculation.
}
\examples{
\dontrun{
# Calculate duration using each loan's current rate
duration_results <- calculate_duration(loan_cash_flows)

# Calculate duration using a market rate of 5\%
duration_results <- calculate_duration(loan_cash_flows, discount_rate = 0.05)

# Calculate duration for investor's economic interest with convexity
duration_results <- calculate_duration(
  loan_cash_flows,
  cash_flow_column = "investor_total",
  include_convexity = TRUE
)
}

}
